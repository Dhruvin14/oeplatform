{% extends "dataedit/base.html" %}
{% load staticfiles %}
{% load bootstrap3 %}

{% block data_content %}

<script type="text/javascript" src="{% static 'dataedit/views.js' %}"></script>

<!-- vendor css -->
<link href="{% static 'dataedit/recline/vendor/leaflet/0.7.3/leaflet.css' %}" rel="stylesheet">
<link href="{% static 'dataedit/recline/vendor/leaflet.markercluster/MarkerCluster.css' %}" rel="stylesheet">
<link href="{% static 'dataedit/recline/vendor/leaflet.markercluster/MarkerCluster.Default.css' %}" rel=
        "stylesheet">
<link rel="stylesheet" href="{% static 'dataedit/recline/vendor/slickgrid/2.2/slick.grid.css' %}">

<!-- recline css -->
<link href="{% static 'dataedit/recline/css/map.css' %}" rel="stylesheet">

<link href="{% static 'dataedit/recline/css/multiview.css' %}" rel="stylesheet">
<link href="{% static 'dataedit/recline/css/slickgrid.css' %}"rel="stylesheet">
<link href="{% static 'dataedit/recline/css/flot.css' %}" rel="stylesheet">
<link href="https://raw.githubusercontent.com/tobiasahlin/SpinKit/master/css/spinkit.css" rel="stylesheet">
<!-- Vendor JS - general dependencies -->

<script type="text/javascript">
    var bs_jQuery = $.noConflict(true);
</script>

<script src="{% static 'dataedit/recline/vendor/jquery/1.7.1/jquery.js' %}" type="text/javascript"></script>
<script src="{% static 'dataedit/recline/vendor/underscore/1.4.4/underscore.js' %}" type="text/javascript"></script>
<script src="{% static 'dataedit/recline/vendor/backbone/1.0.0/backbone.js' %}" type="text/javascript"></script>
<script src="{% static 'dataedit/recline/vendor/mustache/0.5.0-dev/mustache.js' %}" type="text/javascript"></script>
{#<script src="{% static 'dataedit/recline/vendor/bootstrap/3.2.0/js/bootstrap.js' %}" type="text/javascript"></script>#}

<!-- Vendor JS - view dependencies -->
<script src="{% static 'dataedit/recline/vendor/leaflet/0.7.3/leaflet.js' %}" type="text/javascript"></script>
<script src="{% static 'dataedit/recline/vendor/leaflet.markercluster/leaflet.markercluster.js' %}" type="text/javascript"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/flot/jquery.flot.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/flot/jquery.flot.time.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/moment/2.0.0/moment.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/slickgrid/2.2/jquery-ui-1.8.16.custom.min.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/slickgrid/2.2/jquery.event.drag-2.2.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/slickgrid/2.2/slick.core.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/slickgrid/2.2/slick.formatters.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/slickgrid/2.2/slick.editors.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/slickgrid/2.2/slick.grid.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/slickgrid/2.2/plugins/slick.rowselectionmodel.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/recline/vendor/slickgrid/2.2/plugins/slick.rowmovemanager.js' %}"></script>
<!-- Recline JS (combined distribution, all views) -->
<script type="text/javascript" src="{% static 'dataedit/recline/dist/recline.js' %}"></script>

<script type="text/javascript" src="{% static 'dataedit/editors.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/backend.js' %}"></script>
<script type="text/javascript" src="{% static 'dataedit/dumps.js' %}"></script>

<script>
    unchecked = false;
    function swap_checked(){
        unchecked = !unchecked;
        build_views();
    }
</script>

<script type="text/javascript">
    var preview_dataset = new recline.Model.Dataset({
        table: '{{table}}',
        schema: '{{schema}}',
        backend: 'OEP',
    });

    var graph;
    var data;
    var map;

    preview_dataset.fetch().done(function(dataset) {
        data = dataset;

        var is_first = true;
        var first_column;
        dataset.fields.each(function(field) {
            if (is_first) { first_column = field; is_first = false; }
        });

        {% if type == "graph" %}
            var id_columns = $('#id_columns');
            id_columns.append('<table>');
            var column_number = 0;
            {% if y_axis %}
            graph_series = {{ y_axis|safe }};
            {% else %}
            graph_series = [];
            {% endif %}
            graph_group = first_column.id;
            dataset.fields.each(function(field) {
                if (column_number == 0)
                    id_columns.append('<tr>');

                var is_selected = false;
                for (var i = 0; i < graph_series.length; i++) {
                if (graph_series[i] == field.id) {
                    is_selected = true;
                    }
                }
                if (is_selected)
                {
                    id_columns.append('<td><input class="column-checkbox" onclick=\"y_axis_change()\" type=\"checkbox\" checked id=\"y-'
                        + field.id + '\" name=\"y-axis-' + field.id + '\">&nbsp;&nbsp;</td><td><label for=\"y-' + field.id
                        + '\">' + field.id + '</label>&nbsp;&nbsp;&nbsp;</td>');
                }
                else
                {
                    id_columns.append('<td><input class="column-checkbox" onclick=\"y_axis_change()\" type=\"checkbox\" id=\"y-'
                        + field.id + '\" name=\"y-axis-' + field.id + '\">&nbsp;&nbsp;</td><td><label for=\"y-' + field.id
                        + '\">' + field.id + '</label>&nbsp;&nbsp;&nbsp;</td>');
                }

                if (column_number == 3) { id_columns.append('</tr>'); column_number = 0; }
                else { column_number++; }
            });
            id_columns.append('</table>');

            var id_x_axis = $('#id_x-axis');
            dataset.fields.each(function(field) {
                id_x_axis.append('<option value=\"' + field.id + '\" style=\"border: none;\"> ' + field.id + '</option>');
            });

            {% if x_axis %}
                id_x_axis.val("{{ x_axis }}");
                graph_group = "{{ x_axis }}";
            {% endif %}

        {% elif type == "map" %}

            var id_geo_data = $('#id_geo_data');
            var id_geo_lat = $('#id_geo_lat');
            var id_geo_long = $('#id_geo_long');
            dataset.fields.each(function(field) {
                id_geo_data.append('<option value=\"' + field.id + '\" style=\"border: none;\"> ' + field.id + '</option>');
                id_geo_lat.append('<option value=\"' + field.id + '\" style=\"border: none;\"> ' + field.id + '</option>');
                id_geo_long.append('<option value=\"' + field.id + '\" style=\"border: none;\"> ' + field.id + '</option>');
            });

            {% if geo_column %}
                id_geo_data.val("{{ geo_column }}");
            {% elif geo_long and geo_lat %}
                id_geo_long.val("{{ geo_long }}");
                id_geo_lat.val("{{ geo_lat }}");
            {% endif %}

        {% endif %}

        var $el = $('#container');

        {% if type == "table" %}

            var grid = new recline.View.SlickGrid({
                model: dataset,
                el: $el
            });
            grid.visible = true;
            grid.render();

        {% elif type == "graph" %}

            graph = new recline.View.Graph({
                model: dataset,
                el: $el,
                state:
                {
                    graphType: "lines-and-points",
                    group: graph_group,
                    series: graph_series
                }
            });
            graph.render();
            graph.redraw();

        {% elif type == "map" %}

            map = new recline.View.Map({
                model: dataset,
                el: $el,
                state:
                {
                    {% if geo_type == "single-column" %}
                        geomField: "{{ geo_column }}"
                    {% elif geo_type == "lat_long" %}
                        lonField: "{{ geo_long }}",
                        latField: "{{ geo_lat }}"
                    {% else %}
                        geomField: first_column.id
                    {% endif %}
                }
            });
            map.render();

        {% endif %}
    });

    function x_axis_change()
    {
        graph_group = document.getElementById("id_x-axis").value;
        updateGraph();
    }

    function y_axis_change()
    {
        var list = [];
        data.fields.each(function(field) {
            var checkbox = document.getElementById("y-" + field.id);
            if (checkbox.checked) { list.push(field.id); }
        });
        graph_series = list;
        updateGraph();
    }

    var graph_group;
    var graph_series;
    function updateGraph()
    {
        graph = new recline.View.Graph({
            model: graph.model,
            el: graph.el,
            state:
            {
                graphType: "lines-and-points",
                group: graph_group,
                series: graph_series
            }
        });
        graph.render();
        graph.redraw();
    }

    var toggle_all_columns = $("#toggle-all").checked;
    function toggle_all()
    {
        toggle_all_columns = !toggle_all_columns;
        $(".column-checkbox").each(function(nr, item) { item.checked = toggle_all_columns; });
        y_axis_change();
    }

    function geo_data_changed()
    {
        if (document.getElementById("location_single_column").checked)
        {
            map = new recline.View.Map({
                model: map.model,
                el: map.el,
                state:
                {
                    geomField: document.getElementById("id_geo_data").value
                }
            });
            map.render();
        }
        else
        {
            map = new recline.View.Map({
                model: map.model,
                el: map.el,
                state:
                {
                    lonField: document.getElementById("id_geo_long").value,
                    latField: document.getElementById("id_geo_lat").value
                }
            });
            map.render();
        }
    }
</script>

{% if not new %}
<h3>Modify {{ view.name }}</h3>
{% elif type == "table" %}
<h3>Create a new table</h3>
{% elif type == "graph" %}
<h3>Create a new graph</h3>
{% elif type == "map" %}
<h3>Create a new map</h3>
{% endif %}

<form action="{{ request.path }}/save" method="post">
    {% csrf_token %}
    <input type="hidden" name="type" value="{{ type }}">
    {% if not new %}
    <input type="hidden" name="id" value="{{ view.id }}">
    {% endif %}
    <table style="tabel-layout: fixed; width: 100%">
        <tr>
            <td>
                <label for="id_name">Name</label>
            </td>
            <td>
                <input id="id_name" type="text" class="form-control"
                       value="{% if not new %}{{ view.name }}{% endif %}" name="name">
            </td>
        </tr>
        {% if type == "graph" %}
        <tr>
            <td>
                <br>
                <label for="id_x-axis">
                    Select x-axis
                </label>
            </td>
            <td>
                <br>
                <select id="id_x-axis" name="x-axis" class="form-control" onchange="x_axis_change()"></select>
            </td>
        </tr>
        <tr>
            <td>
                <label for="id_columns">
                    Select y axis
                </label>
            </td>
            <td>
                <br>
                <div id="id_columns">
                </div>
                <br>
                <input type="checkbox" id="toggle-all" onclick="toggle_all();"> Toggle all
                <br>
            </td>
        </tr>
        {% endif %}
        {% if type == "map" %}
        <tr>
            <td>
                <label>Location data</label>
            </td>
            <td>
                <br>
                <br>
                <table style="tabel-layout: fixed; width: 100%">
                    <colgroup>
                       <col span="1" style="width: 5%;">
                       <col span="1" style="width: 25%;">
                       <col span="1" style="width: 70%;">
                    </colgroup>
                    <tr>
                        <td>
                            <input type="radio" id="location_single_column" name="location_type"
                                   value="single-column" onchange="geo_data_changed()"
                                   {% if geo_type == "single-column" %}checked{% endif %}>
                        </td>
                        <td colspan="2">
                            <label for="location_single_column">Single column with geo_point or GeoJSON</label>
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                        <td colspan="2">
                            <select id="id_geo_data" name="geo_data" class="form-control" onchange="geo_data_changed()">
                            </select>
                            <br>
                        </td>
                    </tr>

                    <tr>
                        <td>
                            <input type="radio" id="location_lat_long" name="location_type"
                                   value="lat_long" onchange="geo_data_changed()"
                                   {% if geo_type == "lat_long" %}checked{% endif %}>
                        </td>
                        <td colspan="2">
                            <label for="location_lat_long">Latitude and longitude</label>
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                        <td><label for="id_geo_lat">Latitude</label></td>
                        <td>
                            <select id="id_geo_lat" name="geo_lat" class="form-control" onchange="geo_data_changed()">
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td></td>
                        <td><label for="id_geo_long">Longitude</label></td>
                        <td>
                            <select id="id_geo_long" name="geo_long" class="form-control" onchange="geo_data_changed()">
                            </select>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
        {% endif %}
    </table>

    <br>
    <label>Preview</label>
    <br>

    <div id="container" style="min-height: 500px">
    </div>

    <br>

    <input type="submit" class="btn btn-success" value="Save">
    <a href="/dataedit/view/{{ schema }}/{{ table }}{% if not new %}?view={{ view.id }}{% endif %}"
       class="btn btn-default">Cancel</a>
</form>

{% endblock %}