{% extends 'dataedit/dataview.html' %}

{% block title %} - {{schema}}.{{table}}{% endblock %}

{% block heading %}
    <h3><a href="/dataedit/view/{{schema}}">{{schema}}</a>.{{table}} </h3>
        <table>
            <tr>
                <td>
                    <a href="{{table}}/comments" alt="Comments" class="glyphicon glyphicon-list-alt"> </a>
                </td>
                <td style="padding:5px">
                    <a href="{{table}}/download" class="glyphicon glyphicon-download-alt"> </a>
                </td>
                <td>
                    <a href="{{table}}/permissions" class="glyphicon glyphicon-user"> </a>
                </td>
            </tr>
        </table>

    <div class="well">Below is the data that is contained in the table you selected. Only a limited
    amout of data is fetched at one time. You can browse different chuncks of data using the
    data view interface. <br>
    If this table contains geometrical data, the data backend translates this cells
    to human-readable geoJSON. You can plot these datapoints in a designated map view.
    </div>

    <div class="well">
        <h4>Currently defined views:</h4>

        {% for view in views %}
        <a href="{{ request.path }}?view={{ view.id }}" class="btn btn-default {% if view.id == current_view.id %}active{% endif %}">{{ view.name }}</a>
        {% endfor %}
        {% if not views %}
        No views were created yet.
        {% endif %}

        <br><br>

        <div>
                {% if current_view.id %}
            <span style="float: left">
                <a href="{{ request.path }}/view?id={{ current_view.id }}" class="btn btn-default">Edit active view</a>
                <a href="{{ request.path }}/view/set-default?id={{ current_view.id }}" class="btn btn-default">Set as default</a>
                <a href="{{ request.path }}/view/delete?id={{ current_view.id }}" class="btn btn-danger">Delete active view</a>
            </span>
                {% endif %}
            <span style="float: right">
                <a href="{{ request.path }}/view?type=table" class="btn btn-default">New table</a>
                <a href="{{ request.path }}/view?type=graph" class="btn btn-default">New graph</a>
                <a href="{{ request.path }}/view?type=map" class="btn btn-default">New map</a>
            </span>
            <br clear="all">
        </div>
    </div>

    <div id="main-visualization-container" style="min-height: 500px">
    </div>

{% endblock %}

{% block script %}

<script type="text/javascript">


    var data_record = {}
    var unchecked_record = {}

    function build_views(){
        var dataset_main = new recline.Model.Dataset({
                table: '{{table}}',
                schema: '{{schema}}',
                backend: 'OEP',
                has_row_comments: {% if has_row_comments %} true {% else %} false {% endif %}
        });

        {% if filter %}
            var query = new recline.Model.Query();
            {% for f in filter %}

            {% if f.type == "equal" %}
                query.addFilter(
                {
                    type: 'term',
                    field: "{{ f.column }}",
                    term: "{{ f.value.value }}"
                });
            {% elif f.type == "range" %}
                query.addFilter(
                {
                    type: 'range',
                    field: "{{ f.column }}",
                    from: "{{ f.value.start }}",
                    to: "{{ f.value.end }}"
                });
            {% endif %}

            {% endfor %}
            dataset_main.query(query);
        {% endif %}

        dataset_main.fetch().done(function(dataset) {


            var visualization_container = $('#main-visualization-container');
            {% if current_view.type == "table" %}
                var grid = new recline.View.SlickGrid({
                    model: dataset,
                    el: visualization_container,
                    state: {
                      gridOptions: {
                        enableCellNavigation: true,
                        forceFitColumns: true
                        fullWidthRows: true
                      }
                    }
                });

                grid.visible = true;
                grid.render();

                // add comment tooltip for columns
                var columns = grid.grid.getColumns();

                var fields = {{ comment_on_table.fields | safe }};

                for (var i = 0; i < columns.length;i++)
                {
                    for (var j = 0; j < fields.length; j++)
                    {
                        if (columns[i].name === fields[j].name)
                            columns[i].toolTip = fields[j].description;
                    }
                }

                grid.grid.setColumns(columns);
                grid.render();

            {% elif current_view.type == "graph" %}
                var graph = new recline.View.Graph({
                    model: dataset,
                    el: visualization_container,
                    state:
                    {
                        graphType: "lines-and-points",
                        group: "{{ x_axis }}",
                        series: {{ y_axis|safe }}
                    }
                });
                graph.render();
                graph.redraw();
            {% elif current_view.type == "map" %}

                var map = new recline.View.Map({
                    model: dataset,
                    el: visualization_container,
                    state:
                    {
                        {% if geo_type == "single-column" %}
                        geomField: "{{ geo_column }}"
                        {% elif geo_type == "lat_long" %}
                        lonField: "{{ geo_long }}",
                        latField: "{{ geo_lat }}"
                        {% endif %}
                    }
                });
                map.render();

                var geoJSON;

                var left = map.map.getBounds().getEast();
                var right = map.map.getBounds().getWest();
                var top = map.map.getBounds().getNorth();
                var bottom = map.map.getBounds().getSouth();

                $.ajax({
                    url: "/api/get_map_polygons",
                    data:
                        {
                            'schema': '{{ schema }}',
                            'table': '{{ table }}',
                            'bounds': '{ "type": "Polygon", "coordinates":[[[' +
                                      left  + ',' + top    + '],' +
                                '[' + right + ',' + top    + '],' +
                                '[' + right + ',' + bottom + '],' +
                                '[' + left  + ',' + bottom + '],' +
                                '[' + left  + ',' + top    + ']]] }'
                        },
                    success: function(result){
                        geoJSON = L.geoJson(result["geom"]).addTo(map.map);
                }});

                // reload map data when view is moved via dragging
                map.map.on('dragend', function onDragEnd(){

                    left = map.map.getBounds().getEast();
                    right = map.map.getBounds().getWest();
                    top = map.map.getBounds().getNorth();
                    bottom = map.map.getBounds().getSouth();

                    $.ajax({
                        url: "/api/get_map_polygons",
                        data:
                            {
                                'schema': '{{ schema }}',
                                'table': '{{ table }}',
                                'bounds': '{ "type": "Polygon", "coordinates":[[[' +
                                    left + ',' + top + '],' +
                                    '[' + right + ',' + top + '],' +
                                    '[' + right + ',' + bottom + '],' +
                                    '[' + left + ',' + bottom + '],' +
                                    '[' + left + ',' + top + ']]] }'
                            },
                        success: function(result){
                            geoJSON.clearLayers();
                            geoJSON = L.geoJson(result["geom"]).addTo(map.map);
                    }});

                });
            {% endif %}
        });

        if(unchecked){

            $("#unchecked_data_div").css("display", "block");
            var dataset_unchecked = new recline.Model.Dataset({
                    table: '_{{table}}_edit',
                    schema: '_{{schema}}',
                    backend: 'OEP',
                    has_row_comments: false
            });

            dataset_unchecked.fetch().done(function(dataset) {
                plot_view(dataset,
                    false,
                    $('.data-unchecked-explorer-here'), unchecked_record)
            });
        }
        else
            $("#unchecked_data_div").css("display", "none");


        $('#savebutton').bind('click',
        function() {
            changes = {
                creates: dataset_main._changes.creates,
                updates:    dataset_main.records.filter(
                    function(el){return !(jQuery.isEmptyObject(el.changed));}),
                deletes: dataset_main._changes.deletes
            };

            dataset_main.backend.save(changes, dataset_main);
        });
    }

    build_views(false);

    </script>

{% endblock %}